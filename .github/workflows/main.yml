name: Build Full Stack Application
on:
  push:
    branches: [ main, master ]   # 在推送到main或master分支时触发
  pull_request:
    branches: [ main, master ] 
jobs:
  build:
    runs-on: ubuntu-latest      # 使用最新的Ubuntu运行器

    steps:
    # 步骤1: 检出代码
    - name: Checkout code
      uses: actions/checkout@v4 # 使用checkout动作获取仓库代码

    # 步骤2: 设置JDK（用于后续的Maven构建）
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 步骤3: 设置Node.js（用于构建Angular项目）
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'      # 指定Node.js版本，根据你的项目要求调整

    # 步骤4: 构建Angular前端项目
    - name: Build Angular project
      run: |
        cd front/sugar             # 进入front/sugar目录
        npm install                # 安装依赖
        which ng
        npm run ng build --configuration=production

    # 步骤5: 复制Angular构建产物到后端目录
    - name: Copy Angular dist to backend
      run: |
        # 创建后端目标目录（如果不存在）
        # 复制front/sugar/dist/sugar/browser下的所有文件到backend/sugar/src/main/resources/static/public/sugar/
        ls -la front/sugar/dist/sugar/browser
        cp front/sugar/dist/sugar/browser/*.js backend/sugar/src/main/resources/static/public/sugar/
        cp front/sugar/dist/sugar/browser/*.css backend/sugar/src/main/resources/static/public/sugar/
        cp front/sugar/dist/sugar/browser/*.html backend/sugar/src/main/resources/static/public/sugar/
        ls -la backend/sugar/src/main/resources/static/public/sugar/

    # 步骤6: 设置Maven依赖缓存（可选，但可显著加速后续构建）
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository   # Maven本地仓库路径
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }} # 根据pom.xml变化失效缓存
        restore-keys: |
          ${{ runner.os }}-maven-

    # 步骤7: 使用Maven打包后端项目
    - name: Package with Maven
      run: |
        cd backend/sugar              # 进入backend目录
        mvn clean package             # 执行Maven打包命令

    # 步骤8: （可选）上传构建产物（如JAR包）以便后续下载
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: sugar     # 构件名称，替换为你的应用名
        path: backend/sugar/target/*.jar # 上传backend/target目录下的所有JAR文件
    # 步骤9: 创建release
